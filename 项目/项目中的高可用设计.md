# 一、什么是高可用

### 1.什么是可用性

可用性是指的是在某个考察时间，系统可以正常运行的概率或者是时间占有比率

### 2.高可用

通过尽量缩短因为**日常维护操作** (人为操作)和**突发系统崩溃** (非人为操作)而导致系统停机的时间，来提高系统的可用性。 

高可用主要是为了保证业务的连续性、稳定性

**可用性计算公式**

- 总可用性 = (运行时间 - 停机时间 ) / 运行时间

**企业级高可用目标**

​    很多公司的高可用指标是99.99%, 故障时间参考如下图：



![img](https://cdn.nlark.com/yuque/0/2022/png/22268311/1668427563324-b403619d-5a08-4c0e-8e8e-c1aecc67fa64.png)

# 二、如何实现高可用

[📎高可用.xmind](https://www.yuque.com/attachments/yuque/0/2022/xmind/22268311/1668479228451-af3c0e59-14dd-4673-a2b3-9c9b0705407e.xmind)

## ![img](https://cdn.nlark.com/yuque/0/2022/png/22268311/1668479362547-a9a9f9f6-f858-4608-bfe3-e8d8da9a8121.png)

## 1.架构层面

处理措施**：冗余**和**自动故障转移**

### 冗余

冗余的思想： 使用相同的服务部署多份，如果正在使用的服务挂掉，系统可以切换到备份服务上，大大减少不可用时间

单机是高可用的大敌，所以组件一般是**集群**的形式出现的，只要有一个机器出现问题，其他机器就可以代替，假设一台机器可用性为90%，那么两台机器搭建的集群可用性为1-0.1*0.1 = 99%，冗余机器越多，可用性越高

#### 冗余方案

高可用集群，同城灾备，异地灾备，同城多活，异地多活

- **高可用集群：**同一份服务部署两份或多分，当正在使用的服务挂掉，可以切换到另外一个服务
- **同城灾备：**相同的服务部署在同一个城市的不同机房，备用服务不处理请求，避免意外情况
- **异地灾备：**和同城灾备类似，不过是相同服务部署在异地
- **同城多活：**类似同城灾备，不过备用服务也处理请求，利用系统资源，提高系统并发
- **异地多活：**服务部署在异地的不同机房，备用服务也可以处理请求

#### 集群/双机架构

**主备架构：**

备份作用，不承担读写业务

缺点：

- 只作为备份，不承担读写操作，性能浪费
- 故障需人工干预

**主从架构：**

缺点：

- 客户端需要感知主从关系，把不同操作发给不同机器处理
- 主从复制延迟，业务会出现不一致

**主主双机架构：**

两个都是主机，可以互相复制数据给对象，客户端挑选一个机器读

缺点：

- 需要数据双向复制，但是自增ID或者库存这些就不能双向复制
- 适用于可丢失，可覆盖的场景

不过做好冗余还不够，往往需要故障转移的配合

### 故障转移

故障转移：实现不可用服务**快速且自动**切换到可用服务，过程无需人为干涉

场景1：

Redis集群中的哨兵模式， 如果*Sentinel(哨兵)*检测到了master节点故障，它就会借助选举机制自动实现故障转移，选举一个slave升级为master,确保redis系统的可用性，整个过程是自动的，不需要人工介入

场景2：

Nginx可以和KeepAlived搭配使用进而实现高可用，如果Nginx主服务器宕机，KeepAlived可以实现自动故障转移，备用Nginx服务器会升级为主服务器，这个切换对外面是透明的，而且因为是使用的虚拟IP，虚拟IP不会改变

KeepAlived: 是集群管理中保证集群高可用的一款软件，防止单点故障

为什么可以防止单点故障，工作原理？：

KeepAlived是基于VRRP(虚拟路由冗余)协议的基础实现的

工作原理： 将N台路由器组成一个路由器组，组内有一个master和多个backup,master会发起组播，当

当backup没有收到VRRP包就会认为master宕掉了，就会根据VRRP优先级选取backup为master，保证路由的高可用

## 2.事前准备

### 限流

限制请求速率，避免瞬时大量请求击垮系统，超过处理能力的范围，软件系统可能就直接挂掉

限流会导致用户请求无法被处理，不过，这也是权衡软件系统稳定得到的最优解

现实生活中，限流的应用也存在，比如排队买票是为了避免大量用户涌入买票导致售票员无法处理

#### 1.固定窗口计数器

固定在一段时间内,比如1min内限制多少请求，超过这个请求就拒绝访问

坏处：无法限制速率，无法保证激增的流量

#### 2.滑动窗口计数器算法

相比于固定窗口计数器，**它会按照时间进行分片**

**滑动格子越多，滑动窗口滚动越平滑，限流统计越准确**

#### 3.漏桶算法

实现思想：队列保存请求，定期从队列拿出来请求执行

![img](https://cdn.nlark.com/yuque/0/2022/png/22268311/1668487385965-d1fa7d00-4c63-48d2-92c6-a84bdf08faba.png)

#### 4.令牌桶算法

桶里装的是令牌，我们以根据限流大小固定速率添加令牌，令牌桶慢不能添加令牌

请求在被处理前需拿到令牌，处理后丢弃令牌

![img](https://cdn.nlark.com/yuque/0/2022/png/22268311/1668487709915-2db0acb2-0b46-4a19-85ec-1818c1cffef4.png)



### 降级

本质：弃车保帅，临时舍弃部分功能，保证整体可用性

例1：第三方资金方因为自身原因借款功能出问题导致无法借款，为了避免用户空话，于是在用户第三方借款的时候返回了一个（为提升您的额度，资金方正在升级）的文案，避免了用户投诉

例2：用户观看直播卡顿严重，运营商的优先策略不是先排查原因，而是先给用户自动降低码率，比起画质来说，卡顿可能更无法接受

例3：双十一高峰期的时候，电商平台往往会把一些不重要的模块给停掉，比如说注册用户模块，来保证其他流程的顺利运行

### 熔断：

服务降级的一种，为了避免服务挂掉，当请求到这个服务的失败量达到一定数量的时候，下次请求就不会让该服务处理，而是直接返回错误

![img](https://cdn.nlark.com/yuque/0/2022/png/22268311/1668489375726-c1d73ced-6d28-4f79-9a0c-1b3c39f61841.png)

除此之外还有

- 页面降级：可视化界面禁止点击
- 写降级
- 读降级
- 延迟服务：任务延时处理，消息进入MQ之后延迟处理等
- 停服务：关掉不重要的功能，前面说的双11就是

### 压力测试

![img](https://cdn.nlark.com/yuque/0/2022/png/22268311/1668490391398-c35eb8b1-9617-459c-af70-0a0320561566.png)

压测需要关注一下几个点

- QPS： 每秒查询量，只要查询到结果就算一次请求
- RT：相应时间爱你
- GC：垃圾回收
- CPU/内存/网络也都需要关注

## 3.事发措施

### 监控+日志进行问题的及时发现和排查

### ![img](https://cdn.nlark.com/yuque/0/2022/png/22268311/1668491023042-56ef796b-0168-4d63-8cdf-d37dfa0fc287.png)

上图左侧是消息队列，中间是k8s搭建的集群，右边是监控系统，我们监控系统使用grafana打点监控，只要超过多少就会报警，日志的话是用logstash提取文件到ES中使用kibana面板查看的



grafana示意图：![img](https://cdn.nlark.com/yuque/0/2022/png/22268311/1668491152431-fbd29a2a-fefc-45ba-b4f1-d323611ea999.png)

### 记录之前发行版本

每次发布新的版本之前最好要记录之前发布的版本，便于线上真的出问题了的快速回滚，以免造成更多的损失

## 4.事后复盘

- 复盘项目中出问题的点为什么会有这样的问题，如何改进
- 从出问题之前到出问题再到解决问题，有哪些点可以改进
- 技术点方面有哪些可以进行改进

### 参考文章/博客

**1.** [高可用介绍](https://blog.csdn.net/weixin_45387943/article/details/123176415?ops_request_misc=&request_id=&biz_id=102&utm_term=高可用&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-123176415.142^v63^opensearch_v2,201^v3^control_1,213^v2^t3_esquery_v2&spm=1018.2226.3001.4187)

2.[什么是高可用](https://www.cnblogs.com/magita/p/12779057.html)

3.[从各层分析高可用](https://blog.csdn.net/sxlzs_/article/details/81906791?ops_request_misc=&request_id=&biz_id=102&utm_term=高可用&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-2-81906791.142^v63^opensearch_v2,201^v3^control_1,213^v2^t3_esquery_v2&spm=1018.2226.3001.4187)

4.[高可用系统常用解决手段浅述](http://t.zoukankan.com/echo1937-p-6672154.html)

5.[分布式系统之高可用方案](https://blog.csdn.net/AWEI1024/article/details/109343547)

6.[JavaGuide高可用设计](https://javaguide.cn/high-availability/high-availability-system-design.html#什么是高可用-可用性的判断标准是啥)

7.[亿级流量架构进阶之路](https://www.upyun.com/tech/article/668/亿级流量系统架构演进之路.html)

8.[高可用架构实践](https://www.agora.io/cn/community/blog/24224)

9.[高并发和高可用的一点思考](http://kriszhang.com/high_performance/#高可用)

10.[高可用架构](https://segmentfault.com/a/1190000041831699)